services:
  # --- Oracle (commun dev/prod) ---
  oracle:
    image: gvenzl/oracle-free:latest
    container_name: oracle-db
    ports:
      - "1521:1521"
      - "5500:5500"
    environment:
      ORACLE_PASSWORD: ${ORACLE_PASSWORD}
      APP_USER: ${APP_USER}
      APP_USER_PASSWORD: ${APP_USER_PASSWORD}
    volumes:
      - oradata:/opt/oracle/oradata
    healthcheck:
      test: ["CMD", "/opt/oracle/scripts/healthcheck.sh"]
      interval: 15s
      timeout: 5s
      start_period: 10m
      retries: 80

  # Frontend DEV: ng serve (hot reload)
  frontend-dev:
    profiles: ["dev"]
    image: node:22-bookworm-slim
    container_name: web-dev
    working_dir: /app
    command: >
      sh -lc "
        npm ci --no-fund --no-audit || npm install --no-fund --no-audit;
        npx ng serve --host 0.0.0.0 --port 4200 --poll 2000
      "
    volumes:
      # ‚ùå supprime ":cached" ici aussi pour le hot reload Angular
      - ./frontend:/app
      - node-cache:/root/.npm
      - node-modules:/app/node_modules
    environment:
      API_BASE_URL: http://host.docker.internal:8080
      CHOKIDAR_USEPOLLING: "true"
    ports:
      - "4300:4200"

volumes:
  oradata:
  maven-cache:
  node-cache:
  node-modules:
